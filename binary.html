```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【天啟核心】緊急代碼輸入協議：二進位拆彈遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Custom animations */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 0, 1); }
            100% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 0, 1); }
            100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
        }
        .pulse-green { animation: pulse-green 0.5s; }
        .pulse-red { animation: pulse-red 0.5s; }
        .wire-intact { border-top: 4px solid; }
        .wire-cut { border-top: 4px dashed; height: 50%; }
        .shadow-warning-low { text-shadow: 0 0 5px yellow; }
        .shadow-warning-high { text-shadow: 0 0 10px red; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col items-center justify-center p-4">
    <div id="game-container" class="max-w-4xl w-full bg-gray-800 rounded-lg shadow-2xl p-6 border border-gray-600">
        <h1 class="text-3xl font-bold text-red-500 mb-4 text-center">【天啟核心】緊急代碼輸入協議：二進位拆彈遊戲</h1>
        <p class="text-sm mb-6 text-center">在「方舟城市」的深層結構中，維護城市運作的超級智能中樞「巴比倫之塔」正面臨毀滅性的「太陽閃焰衝擊」。您必須在時間內將解鎖編號轉換為二進位指令序列。</p>
        
        <!-- Settings -->
        <div id="settings" class="mb-6">
            <label class="block mb-2">線路數：</label>
            <select id="wire-count" class="bg-gray-700 text-white p-2 rounded w-full mb-4">
                <option value="4">4</option>
                <option value="6">6</option>
                <option value="8">8</option>
                <option value="10">10</option>
                <option value="12">12</option>
            </select>
            <label class="block mb-2">倒數時間 (秒)：</label>
            <input type="number" id="timer-duration" value="60" min="30" max="300" class="bg-gray-700 text-white p-2 rounded w-full mb-4">
            <label class="block mb-2">目標號碼 (留空為隨機)：</label>
            <input type="number" id="target-number" class="bg-gray-700 text-white p-2 rounded w-full mb-4">
            <button id="start-game" class="bg-red-600 text-white px-4 py-2 rounded w-full hover:bg-red-700">啟動任務</button>
        </div>
        
        <!-- Game Area -->
        <div id="game-area" class="hidden">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-bold">目標解鎖編號：</h2>
                <span id="target-display" class="text-5xl text-yellow-400 animate-pulse"></span>
            </div>
            <div class="text-center mb-4">
                <h2 class="text-xl">剩餘時間：</h2>
                <span id="timer-display" class="text-4xl text-white shadow-warning-low"></span>
            </div>
            <div id="wire-grid" class="grid grid-cols-3 gap-4 mb-6"></div>
            <button id="confirm" class="bg-green-600 text-white px-4 py-2 rounded w-full hover:bg-green-700">確認序列</button>
        </div>
    </div>
    
    <!-- Message Box -->
    <div id="message-box" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-75 hidden">
        <div class="bg-gray-800 p-6 rounded-lg text-center">
            <p id="message-text" class="text-2xl mb-4"></p>
            <button id="close-message" class="bg-blue-600 text-white px-4 py-2 rounded">關閉</button>
        </div>
    </div>
    
    <script>
        // Game variables
        let wireCount = 4;
        let timerDuration = 60;
        let targetNumber = 0;
        let wires = [];
        let timerInterval;
        let remainingTime;
        let bgmLoop;
        let currentBPM = 60;
        
        // Tone.js setup
        const synth = new Tone.Synth({ oscillator: { type: 'square' } }).toDestination();
        const metalSynth = new Tone.MetalSynth().toDestination();
        const polySynth = new Tone.PolySynth().toDestination();
        const noiseSynth = new Tone.NoiseSynth().toDestination();
        const membraneSynth = new Tone.MembraneSynth().toDestination();
        
        // Start game
        document.getElementById('start-game').addEventListener('click', async () => {
            await Tone.start();
            wireCount = parseInt(document.getElementById('wire-count').value);
            timerDuration = parseInt(document.getElementById('timer-duration').value);
            const manualTarget = parseInt(document.getElementById('target-number').value);
            const maxTarget = Math.pow(2, wireCount) - 1;
            targetNumber = isNaN(manualTarget) || manualTarget < 0 || manualTarget > maxTarget ? Math.floor(Math.random() * maxTarget) + 1 : manualTarget;
            
            document.getElementById('settings').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('target-display').textContent = targetNumber;
            
            initWires();
            startTimer();
            startBGM();
        });
        
        // Initialize wires
        function initWires() {
            const grid = document.getElementById('wire-grid');
            grid.innerHTML = '';
            wires = [];
            const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange'];
            for (let i = 0; i < wireCount; i++) {
                const wire = document.createElement('div');
                wire.classList.add('bg-gray-700', 'p-4', 'rounded', 'text-center', 'cursor-pointer', 'wire-intact', 'border-t-' + colors[i % colors.length] + '-500');
                wire.dataset.state = '1';
                wire.dataset.index = i;
                wire.textContent = `位元 ${wireCount - 1 - i} (權重: ${Math.pow(2, wireCount - 1 - i)})`;
                wire.addEventListener('click', toggleWire);
                grid.appendChild(wire);
                wires.push(wire);
            }
        }
        
        // Toggle wire state
        function toggleWire(e) {
            const wire = e.target;
            if (wire.dataset.state === '1') {
                wire.dataset.state = '0';
                wire.classList.remove('wire-intact');
                wire.classList.add('wire-cut');
                wire.classList.replace('border-t-', 'border-t-gray-');
                metalSynth.triggerAttackRelease('C2', '8n');
            } else {
                wire.dataset.state = '1';
                wire.classList.remove('wire-cut');
                wire.classList.add('wire-intact');
                const color = wire.textContent.match(/border-t-(\w+)-500/);
                wire.classList.add('border-t-red-500'); // Default, but should retain original
                synth.triggerAttackRelease('C4', '8n');
            }
        }
        
        // Start timer
        function startTimer() {
            remainingTime = timerDuration;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    failGame();
                }
                updateBPM();
            }, 1000);
        }
        
        // Update timer display
        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = remainingTime;
        }
        
        // Update BPM and shadow
        function updateBPM() {
            let newBPM = 60;
            let shadowClass = 'shadow-warning-low';
            if (remainingTime <= 15) {
                newBPM = 90;
                shadowClass = 'shadow-warning-high';
            }
            if (remainingTime <= 5) newBPM = 120;
            if (newBPM !== currentBPM) {
                currentBPM = newBPM;
                bgmLoop.stop();
                bgmLoop = new Tone.Loop(time => {
                    membraneSynth.triggerAttackRelease('C1', '8n', time);
                }, 60 / currentBPM);
                bgmLoop.start(0);
            }
            const timerEl = document.getElementById('timer-display');
            timerEl.classList.remove('shadow-warning-low', 'shadow-warning-high');
            timerEl.classList.add(shadowClass);
        }
        
        // Start BGM
        function startBGM() {
            Tone.Transport.start();
            bgmLoop = new Tone.Loop(time => {
                membraneSynth.triggerAttackRelease('C1', '8n', time);
            }, 60 / currentBPM);
            bgmLoop.start(0);
        }
        
        // Confirm button
        document.getElementById('confirm').addEventListener('click', () => {
            clearInterval(timerInterval);
            bgmLoop.stop();
            validateWires();
        });
        
        // Validate wires
        async function validateWires() {
            let playerValue = 0;
            for (let i = 0; i < wires.length; i++) {
                const state = parseInt(wires[i].dataset.state);
                playerValue += state * Math.pow(2, wireCount - 1 - i);
            }
            if (playerValue === targetNumber) {
                await animateValidation(true);
                successGame();
            } else {
                await animateValidation(false);
                failGame();
            }
        }
        
        // Animate validation
        async function animateValidation(isCorrect) {
            for (let i = 0; i < wires.length; i++) {
                const correctState = (targetNumber >> (wireCount - 1 - i)) & 1;
                const playerState = parseInt(wires[i].dataset.state);
                const animClass = playerState === correctState ? 'pulse-green' : 'pulse-red';
                wires[i].classList.add(animClass);
                await new Promise(resolve => setTimeout(resolve, 500));
                wires[i].classList.remove(animClass);
            }
        }
        
        // Success
        function successGame() {
            polySynth.triggerAttackRelease(['C4', 'E4', 'G4'], '2n');
            showMessage('任務成功！核心已穩定。', true);
        }
        
        // Fail
        function failGame() {
            noiseSynth.triggerAttackRelease('8n');
            showMessage('失敗！核心爆炸。', false);
        }
        
        // Show message
        function showMessage(text, reset) {
            document.getElementById('message-text').textContent = text;
            document.getElementById('message-box').classList.remove('hidden');
            document.getElementById('close-message').addEventListener('click', () => {
                document.getElementById('message-box').classList.add('hidden');
                Tone.Transport.stop();
                if (reset) {
                    document.getElementById('settings').classList.remove('hidden');
                    document.getElementById('game-area').classList.add('hidden');
                } else {
                    location.reload();
                }
            });
        }
    </script>
</body>
</html>
```
